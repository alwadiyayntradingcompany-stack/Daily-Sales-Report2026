<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales Report - تقرير المبيعات اليومية</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="config.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        let googleAuth = null;
        let isGoogleInitialized = false;

        function initializeGoogleAPI() {
            if (typeof gapi === 'undefined' || typeof GOOGLE_CONFIG === 'undefined') {
                console.log('Google API or config not loaded');
                return;
            }
            
            gapi.load('auth2', () => {
                gapi.auth2.init({
                    client_id: GOOGLE_CONFIG.CLIENT_ID,
                }).then(() => {
                    googleAuth = gapi.auth2.getAuthInstance();
                    isGoogleInitialized = true;
                    console.log('Google API initialized successfully');
                }).catch(error => {
                    console.error('Google API initialization failed:', error);
                });
            });
        }

        async function authenticateGoogle() {
            if (!isGoogleInitialized || !googleAuth) {
                throw new Error('Google API not initialized');
            }
            
            if (!googleAuth.isSignedIn.get()) {
                await googleAuth.signIn();
            }
            return googleAuth.currentUser.get().getAuthResponse().access_token;
        }

        async function uploadToGoogleSheets(data) {
            try {
                const token = await authenticateGoogle();
                
                const values = [[
                    data.timestamp,
                    data.date_gregorian,
                    `${data.hijri_year}/${data.hijri_month}/${data.hijri_day}`,
                    data.branch,
                    data.organization,
                    data.responsible,
                    data.machine_number,
                    data.cash,
                    data.pos,
                    data.purchases,
                    data.withdrawals,
                    data.withdrawer_name,
                    data.net_total,
                    'Images uploaded'
                ]];

                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SPREADSHEET_ID}/values/Sheet1:append?valueInputOption=RAW`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        values: values
                    })
                });

                return response.ok;
            } catch (error) {
                console.error('Google Sheets upload error:', error);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeGoogleAPI();
            }, 1000);

            document.getElementById('salesForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const record = {};
                formData.forEach(function(value, key) { 
                    if (key !== 'invoices[]') record[key] = value; 
                });
                
                record.id = Date.now();
                record.timestamp = new Date().toISOString();
                record.net_total = document.getElementById('netTotal').textContent;
                
                try {
                    if (isGoogleInitialized) {
                        const success = await uploadToGoogleSheets(record);
                        if (success) {
                            console.log('Data uploaded to Google Sheets successfully');
                        }
                    }
                } catch (error) {
                    console.error('Google Sheets upload failed:', error);
                }
                
                const records = JSON.parse(localStorage.getItem('allSalesRecords') || '[]');
                records.push(record);
                localStorage.setItem('allSalesRecords', JSON.stringify(records));
                
                document.getElementById('successModal').classList.remove('hidden');
                
                let count = 5;
                const timer = setInterval(function() {
                    count--;
                    document.getElementById('countdown').textContent = count;
                    if (count <= 0) {
                        clearInterval(timer);
                        resetForm();
                    }
                }, 1000);
                
                window.currentTimer = timer;
            });
        });

        function resetForm() {
            if (window.currentTimer) clearInterval(window.currentTimer);
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('salesForm').reset();
            document.getElementById('netTotal').textContent = '0.00 SAR';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</head>
<body>
    <form id="salesForm">
        <input type="text" name="branch" placeholder="Branch" required>
        <input type="text" name="organization" placeholder="Organization" required>
        <input type="text" name="responsible" placeholder="Responsible" required>
        <input type="number" name="cash" placeholder="Cash">
        <input type="number" name="pos" placeholder="POS">
        <input type="number" name="purchases" placeholder="Purchases">
        <input type="number" name="withdrawals" placeholder="Withdrawals">
        <div id="netTotal">0.00 SAR</div>
        <button type="submit">Submit</button>
    </form>
    
    <div id="successModal" class="hidden">
        <h3>Success!</h3>
        <p>Auto redirect in <span id="countdown">5</span>s</p>
        <button onclick="resetForm()">New Record</button>
    </div>
</body>
</html>
